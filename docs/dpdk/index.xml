<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>DPDK on AK-博客</title><link>https://example.docsy.dev/docs/dpdk/</link><description>Recent content in DPDK on AK-博客</description><generator>Hugo</generator><language>zh</language><atom:link href="https://example.docsy.dev/docs/dpdk/index.xml" rel="self" type="application/rss+xml"/><item><title>vfio vs igb_uio</title><link>https://example.docsy.dev/docs/dpdk/vfio-vs-igb_uio/</link><pubDate>Thu, 05 Jan 2017 00:00:00 +0000</pubDate><guid>https://example.docsy.dev/docs/dpdk/vfio-vs-igb_uio/</guid><description>&lt;p&gt;将驱动从 &lt;code&gt;igb_uio&lt;/code&gt; 改为 &lt;code&gt;vfio-pci&lt;/code&gt; 是DPDK发展中的一个重要趋势，主要区别和IOMMU的作用如下：&lt;/p&gt;
&lt;h3 id="核心区别igb_uio-vs-vfio-pci"&gt;核心区别：&lt;code&gt;igb_uio&lt;/code&gt; vs &lt;code&gt;vfio-pci&lt;/code&gt;&lt;a class="td-heading-self-link" href="#%e6%a0%b8%e5%bf%83%e5%8c%ba%e5%88%abigb_uio-vs-vfio-pci" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;table&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;特性&lt;/th&gt;
 &lt;th style="text-align: left"&gt;&lt;strong&gt;igb_uio (Userspace I/O)&lt;/strong&gt;&lt;/th&gt;
 &lt;th style="text-align: left"&gt;&lt;strong&gt;vfio-pci (Virtual Function I/O)&lt;/strong&gt;&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;内核支持&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;依赖 &lt;strong&gt;UIO框架&lt;/strong&gt; 和特定的 &lt;code&gt;igb_uio.ko&lt;/code&gt; 内核模块。&lt;/td&gt;
 &lt;td style="text-align: left"&gt;依赖现代、标准的 &lt;strong&gt;VFIO框架&lt;/strong&gt;，内核原生支持（&amp;gt;= 3.6，完整功能需&amp;gt;=4.0）。&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;安全性/隔离性&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;低&lt;/strong&gt;。UIO直接将设备的全部内存映射暴露给用户空间，用户空间驱动（如DPDK）拥有对硬件的完全、无隔离的访问权限。一个错误的DPDK应用可能破坏系统。&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;高&lt;/strong&gt;。VFIO的核心功能是利用 &lt;strong&gt;IOMMU&lt;/strong&gt; 为设备提供 DMA 地址翻译和访问保护。设备只能访问明确分配给它的内存区域，实现了用户空间与设备之间的安全隔离。&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;虚拟化支持&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;不支持或不完善。很难安全地将一个物理设备直接分配给虚拟机（PCIe Passthrough）。&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;原生支持&lt;/strong&gt;。VFIO正是为安全、高效的硬件直接分配（如KVM的PCIe Passthrough）而设计的。这是它最大的优势之一。&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;依赖要求&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;只需加载&lt;code&gt;igb_uio&lt;/code&gt;模块，对系统配置要求低。&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;必须启用IOMMU&lt;/strong&gt;（在BIOS中开启VT-d/AMD-Vi，并在内核启动参数中启用&lt;code&gt;intel_iommu=on&lt;/code&gt;或&lt;code&gt;amd_iommu=on&lt;/code&gt;）。&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;发展状态&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;DPDK早期采用的方案，&lt;strong&gt;逐渐被淘汰&lt;/strong&gt;。&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;当前推荐的标准方案&lt;/strong&gt;，更安全、更现代，是DPDK和虚拟化生态的未来。&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h3 id="为什么必须在bios中开启iommu支持"&gt;为什么必须在BIOS中开启IOMMU支持？&lt;a class="td-heading-self-link" href="#%e4%b8%ba%e4%bb%80%e4%b9%88%e5%bf%85%e9%a1%bb%e5%9c%a8bios%e4%b8%ad%e5%bc%80%e5%90%afiommu%e6%94%af%e6%8c%81" aria-label="Heading self-link"&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;这是使用 &lt;strong&gt;vfio-pci&lt;/strong&gt; 驱动 &lt;strong&gt;最根本的前提条件&lt;/strong&gt;。原因如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;DMA保护与内存隔离 (核心原因)&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;没有IOMMU时&lt;/strong&gt;：设备进行DMA操作时，使用的是&lt;strong&gt;物理地址&lt;/strong&gt;。一个拥有DMA能力的设备（如网卡）理论上可以读写系统内存的任何位置。如果用户空间的DPDK应用错误地配置了DMA地址，或者设备被恶意软件控制，可能导致系统崩溃或数据泄露。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;开启IOMMU后&lt;/strong&gt;：IOMMU为每个设备（或设备组）维护一个 &lt;strong&gt;I/O 页表&lt;/strong&gt;。当设备发起DMA请求（使用“I/O虚拟地址”（IOVA））时，IOMMU硬件会&lt;strong&gt;实时地将这个地址翻译成真正的物理地址&lt;/strong&gt;。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;关键点&lt;/strong&gt;：这个页表由内核的VFIO驱动严格管控。VFIO只会将DPDK应用申请并映射的特定内存区域的IOVA填入设备的I/O页表。因此，设备&lt;strong&gt;只能访问被明确允许的那部分内存&lt;/strong&gt;，无法触及其他系统内存或内核内存，实现了完美的隔离。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;VFIO框架的基石&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;VFIO框架的设计哲学就是&lt;strong&gt;基于IOMMU的安全设备直接访问&lt;/strong&gt;。它的整个权限控制、内存映射、设备隔离机制都建立在IOMMU硬件功能之上。没有IOMMU，VFIO就无法提供其核心的安全保障，也就失去了它相对于传统UIO的最大优势。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;虚拟化直通 (PCIe Passthrough) 的必备条件&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;将一块物理网卡直接分配给一个虚拟机（VM），让虚拟机独占该设备，这需要最严格的隔离。IOMMU确保：
&lt;ul&gt;
&lt;li&gt;设备的DMA操作只能访问&lt;strong&gt;该虚拟机所属的内存&lt;/strong&gt;，而不能访问宿主机或其他虚拟机的内存。&lt;/li&gt;
&lt;li&gt;设备产生的中断能被正确地重定向到对应的虚拟机。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;没有IOMMU，设备直通在安全上是不可行的。&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;简单比喻：&lt;/strong&gt;&lt;/p&gt;</description></item></channel></rss>